<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinell | Raw Inspector</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: monospace; overflow: hidden; }
        
        /* Layout */
        .main-grid { display: grid; grid-template-columns: 3fr 1fr; height: 100vh; }
        
        /* Video Stage */
        .stage { 
            position: relative; background: #000; border-right: 1px solid #333; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        
        video, img { max-width: 100%; max-height: 100%; display: none; }
        .active-feed { display: block !important; }
        canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }

        /* Sidebar */
        .sidebar { background: #1e1e1e; display: flex; flex-direction: column; overflow: hidden; }
        .panel { padding: 15px; border-bottom: 1px solid #333; }
        
        /* Object List */
        .obj-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .obj-tag {
            display: flex; justify-content: space-between; align-items: center;
            background: #2c2c2c; margin-bottom: 8px; padding: 8px 12px;
            border-radius: 4px; border-left: 4px solid #00ffcc;
            font-size: 14px;
        }

        /* Controls */
        input[type=range] { width: 100%; accent-color: #00ffcc; }
        
        .btn-custom {
            background: #333; color: #fff; border: 1px solid #444; width: 100%; margin-bottom: 5px;
            text-align: left; padding: 8px; font-size: 12px;
        }
        .btn-custom:hover { background: #444; }
        .btn-custom i { width: 20px; color: #00ffcc; }

        /* Loader */
        #loader {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .supported-list { font-size: 10px; color: #666; max-height: 100px; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-info mb-3"></div>
        <h4>LOADING RAW INSPECTOR...</h4>
        <div class="text-muted">Loading 80-Class Dictionary</div>
    </div>

    <div class="main-grid">
        <div class="stage" id="stageContainer">
            <video id="vidFeed" autoplay muted playsinline></video>
            <img id="imgFeed" crossorigin="anonymous">
            <canvas id="aiCanvas"></canvas>
            
            <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">
                <span id="fps" style="color: #00ffcc; font-weight: bold;">FPS: 0</span>
            </div>
        </div>

        <div class="sidebar">
            
            <div class="panel">
                <h6 class="text-muted mb-3">VIDEO SOURCE</h6>
                <button class="btn btn-custom" onclick="startWebcam()"><i class="fas fa-camera"></i> Laptop Webcam</button>
                <button class="btn btn-custom" onclick="startIP()"><i class="fas fa-network-wired"></i> IP Camera URL</button>
                <button class="btn btn-custom" onclick="startScreen()"><i class="fas fa-desktop"></i> Screen Share</button>
            </div>

            <div class="panel">
                <h6 class="text-muted mb-2">SENSITIVITY (CONFIDENCE)</h6>
                <input type="range" min="1" max="100" value="20" id="confSlider" oninput="updateConf(this.value)">
                <div class="d-flex justify-content-between small">
                    <span>See Everything (Messy)</span>
                    <span id="confVal" style="color: #00ffcc;">20%</span>
                    <span>Only Sure Matches</span>
                </div>
            </div>

            <div class="panel bg-dark">
                <h6 class="text-muted">DETECTED OBJECTS (<span id="count">0</span>)</h6>
            </div>
            <div class="obj-list" id="detectionList">
                <div class="text-center text-muted mt-5">Waiting for video...</div>
            </div>

            <div class="panel" style="border-top: 1px solid #333;">
                <small class="text-muted">SUPPORTED OBJECTS (80)</small>
                <div class="supported-list">
                    person, bicycle, car, motorcycle, airplane, bus, train, truck, boat, traffic light, fire hydrant, stop sign, parking meter, bench, bird, cat, dog, horse, sheep, cow, elephant, bear, zebra, giraffe, backpack, umbrella, handbag, tie, suitcase, frisbee, skis, snowboard, sports ball, kite, baseball bat, baseball glove, skateboard, surfboard, tennis racket, bottle, wine glass, cup, fork, knife, spoon, bowl, banana, apple, sandwich, orange, broccoli, carrot, hot dog, pizza, donut, cake, chair, couch, potted plant, bed, dining table, toilet, tv, laptop, mouse, remote, keyboard, cell phone, microwave, oven, toaster, sink, refrigerator, book, clock, vase, scissors, teddy bear, hair drier, toothbrush
                </div>
            </div>

        </div>
    </div>

    <script>
        // CONFIG
        const STATE = {
            model: null,
            activeElement: null,
            ctx: document.getElementById('aiCanvas').getContext('2d'),
            canvas: document.getElementById('aiCanvas'),
            container: document.getElementById('stageContainer'),
            confidence: 0.20,
            isLooping: false
        };

        // 1. LOAD MODEL
        window.onload = async () => {
            try {
                // Force load the 'mobilenet_v2' version (better than lite)
                STATE.model = await cocoSsd.load({ base: 'mobilenet_v2' });
                document.getElementById('loader').style.display = 'none';
                startWebcam(); // Auto start
            } catch (e) {
                alert("Model Failed: " + e.message);
            }
        };

        function updateConf(val) {
            STATE.confidence = val / 100;
            document.getElementById('confVal').innerText = val + "%";
        }

        // 2. SOURCES
        async function startWebcam() {
            reset();
            const vid = document.getElementById('vidFeed');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                vid.srcObject = stream;
                activate(vid);
            } catch (e) { alert("Camera blocked!"); }
        }

        function startIP() {
            reset();
            const url = prompt("Enter IP Webcam URL (e.g. http://192.168.0.100:8080/video):", "http://192.168.0.100:8080/video");
            if(!url) return;
            const img = document.getElementById('imgFeed');
            img.src = url;
            img.onload = () => activate(img);
            img.onerror = () => alert("Can't load URL. Check CORS/WiFi.");
        }

        async function startScreen() {
            reset();
            const vid = document.getElementById('vidFeed');
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                vid.srcObject = stream;
                activate(vid);
            } catch (e) {}
        }

        function reset() {
            STATE.isLooping = false;
            const vid = document.getElementById('vidFeed');
            const img = document.getElementById('imgFeed');
            if(vid.srcObject) vid.srcObject.getTracks().forEach(t => t.stop());
            vid.srcObject = null;
            img.src = "";
            vid.classList.remove('active-feed');
            img.classList.remove('active-feed');
        }

        function activate(el) {
            el.classList.add('active-feed');
            STATE.activeElement = el;
            STATE.isLooping = true;
            resize();
            loop();
        }

        // 3. MAIN LOOP
        async function loop() {
            if(!STATE.isLooping) return;

            // DETECT
            let preds = [];
            try {
                // Use max 100 objects
                preds = await STATE.model.detect(STATE.activeElement, 100, STATE.confidence);
            } catch (e) {}

            // CLEAR
            STATE.ctx.clearRect(0, 0, STATE.canvas.width, STATE.canvas.height);
            
            // DRAW & LIST
            const list = document.getElementById('detectionList');
            list.innerHTML = '';
            
            const scale = getScale();

            preds.forEach(pred => {
                // Calculate position
                const x = (pred.bbox[0] * scale.ratio) + scale.offsetX;
                const y = (pred.bbox[1] * scale.ratio) + scale.offsetY;
                const w = pred.bbox[2] * scale.ratio;
                const h = pred.bbox[3] * scale.ratio;

                // Color based on class name hash
                const color = getColor(pred.class);

                // Draw Box
                STATE.ctx.strokeStyle = color;
                STATE.ctx.lineWidth = 2;
                STATE.ctx.strokeRect(x, y, w, h);

                // Draw Text
                STATE.ctx.fillStyle = color;
                const label = `${pred.class} ${Math.round(pred.score*100)}%`;
                const tw = STATE.ctx.measureText(label).width;
                STATE.ctx.fillRect(x, y > 15 ? y - 15 : y, tw + 6, 15);
                STATE.ctx.fillStyle = '#000';
                STATE.ctx.font = 'bold 10px monospace';
                STATE.ctx.fillText(label, x+3, y > 15 ? y - 4 : y + 11);

                // Add to List Sidebar
                const tag = document.createElement('div');
                tag.className = 'obj-tag';
                tag.style.borderLeftColor = color;
                tag.innerHTML = `
                    <span style="text-transform: capitalize;">${pred.class}</span>
                    <span style="color: #888;">${Math.round(pred.score*100)}%</span>
                `;
                list.appendChild(tag);
            });

            document.getElementById('count').innerText = preds.length;
            requestAnimationFrame(loop);
        }

        // 4. UTILS
        function getScale() {
            const el = STATE.activeElement;
            const cw = STATE.container.clientWidth;
            const ch = STATE.container.clientHeight;
            const vw = el.videoWidth || el.naturalWidth || 640;
            const vh = el.videoHeight || el.naturalHeight || 480;
            
            const ratio = Math.min(cw / vw, ch / vh);
            return {
                ratio: ratio,
                offsetX: (cw - (vw * ratio)) / 2,
                offsetY: (ch - (vh * ratio)) / 2
            };
        }

        function resize() {
            STATE.canvas.width = STATE.container.clientWidth;
            STATE.canvas.height = STATE.container.clientHeight;
        }
        window.onresize = resize;

        function getColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }
    </script>
</body>
</html>